version: 1

envfile: env/.env

scripts:
  setup: |
    PROTOC_ZIP=protoc-3.17.3-linux-x86_64.zip
    curl -OL https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/$PROTOC_ZIP
    sudo unzip -o $PROTOC_ZIP -d /usr/local bin/protoc
    sudo unzip -o $PROTOC_ZIP -d /usr/local 'include/*'
    rm -f $PROTOC_ZIP
    sudo chmod +x /usr/local/bin/protoc

    # install kind
    go install sigs.k8s.io/kind@latest

  test: |
    export ARMADA_EXECUTOR_INGRESS_URL="http://localhost"
    export ARMADA_EXECUTOR_INGRESS_PORT=5001
    ./bin/armadactl create queue e2e-test-queue
    ./bin/testsuite test --tests "testsuite/testcases/basic/*" --junit junit.xml

  test2: |
    ./bin/armadactl create queue e2e-test-queue
    ./bin/testsuite test --tests "testsuite/testcases/basic/submit_1x1.yaml"

  eventingester: |
    export $(cat developer/env/localhost_access.env | xargs)
    ./bin/eventingester

  executor: |
    sudo kill -9 $(sudo lsof -t -i:8080)
    sudo $(cat developer/env/localhost_access.env developer/env/executor.env | xargs) KUBECONFIG=".kube/external/config" ./bin/executor

  server: |
    export $(cat developer/env/localhost_access.env | xargs)
    export ARMADA_HTTPPORT=8081
    ./bin/server --config developer/config/insecure-armada.yaml
