# https://github.com/Sharpz7/dotfiles/blob/main/envs/openstack/sharpdev.yml

version: 1

# envfile: env/.env

# https://docs.opendev.org/opendev/infra-manual/latest/sandbox.html
# https://docs.opendev.org/opendev/infra-manual/latest/developers.html

scripts:
  key: |
    if [ ! -f ~/.ssh/id_rsa ]; then
      touch ~/.ssh/id_rsa
      chmod 600 ~/.ssh/id_rsa
      nano ~/.ssh/id_rsa
    fi

    # if file does not exist (sh)
    if [ ! -f ~/.ssh/config ]; then
      touch ~/.ssh/config
      echo "Host review.opendev.org" >> ~/.ssh/config
      echo "  ForwardAgent yes" >> ~/.ssh/config
    fi

  setup: |
    sudo apt install -y git-review

    echo "*" > ./env/.gitignore
    git config --add gitreview.username "adamcarthur"
    git config core.editor "vscode"
    git review -s

  git-init: |
    eval `ssh-agent`

  # git clone https://opendev.org/opendev/sandbox
  test: |
    git checkout -b testing
    echo "# Hello World" > adam.md
    git add .
    git commit -m "Initial commit from Adam"
    git review -R

    # For Topic
    # git review -R -t testing

  git_config: |
    git config --list --show-origin

  commit: |
    git add .
    git commit -s -m $_ARG1

  latest: |
    git remote update
    git checkout master
    git pull --ff-only origin master

  squash: |
    git checkout master
    git pull origin master
    git checkout TOPIC-BRANCH
    git rebase -i master

  # Note this lives in opt/stack
  deploy: |
    sudo apt install iproute2 -y
    git clone https://opendev.org/openstack/devstack.git devstack
    sudo ./devstack/tools/create-stack-user.sh

  config: |
    cat >./env/local.conf <<END
    [[local|localrc]]
    # Credentials
    ADMIN_PASSWORD=password
    DATABASE_PASSWORD=password
    RABBIT_PASSWORD=password
    SERVICE_PASSWORD=password
    SERVICE_TOKEN=password
    SWIFT_HASH=password
    SWIFT_TEMPURL_KEY=password

    # Set glance's default limit to be baremetal image friendly
    GLANCE_LIMIT_IMAGE_SIZE_TOTAL=5000

    # Enable Ironic plugin
    enable_plugin ironic https://opendev.org/openstack/ironic

    # Disable nova novnc service, ironic does not support it anyway.
    disable_service n-novnc

    # Enable Swift for the direct deploy interface.
    enable_service s-proxy s-object s-container s-account

    # Disable Horizon
    disable_service horizon

    # Disable Cinder
    disable_service cinder c-sch c-api c-vol

    # Configure networking by disabling OVN and enabling Neutron w/OVS.
    disable_service ovn-controller ovn-northd q-ovn-metadata-agent
    disable_service ovn-northd
    enable_service q-agt q-dhcp q-l3 q-svc q-meta
    Q_AGENT=openvswitch
    Q_ML2_PLUGIN_MECHANISM_DRIVERS="openvswitch"
    Q_ML2_TENANT_NETWORK_TYPE="vxlan"
    Q_USE_SECGROUP="False"

    # By default, devstack assumes you have IPv4 and IPv6 access. If you are on
    # a v4-only network, set the value below.
    # IP_ADDRESS=4

    # Swift temp URL's are required for the direct deploy interface
    SWIFT_ENABLE_TEMPURLS=True

    # Support via emulated BMC exists for the following hardware types, and
    # VMs to back them will be created by default unless IRONIC_IS_HARDWARE is
    # True.
    #  - ipmi (VirtualBMC)
    #  - redfish (sushy-tools)
    #
    # If you wish to change the default driver for nodes created by devstack,
    # you can do so by setting IRONIC_DEPLOY_DRIVER to the name of the driver
    # you wish used by default, and ensuring that driver (along with others) is
    # enabled.
    IRONIC_DEPLOY_DRIVER=ipmi

    # Example: Uncommenting these will configure redfish by default
    #IRONIC_ENABLED_HARDWARE_TYPES=redfish,ipmi,fake-hardware
    #IRONIC_DEPLOY_DRIVER=redfish
    # Don't forget that many hardware types require enabling of additional
    # interfaces, most often power and management:
    #IRONIC_ENABLED_MANAGEMENT_INTERFACES=redfish,ipmitool,fake
    #IRONIC_ENABLED_POWER_INTERFACES=redfish,ipmitool,fake

    IRONIC_VM_COUNT=3
    IRONIC_BAREMETAL_BASIC_OPS=True
    DEFAULT_INSTANCE_TYPE=baremetal

    # You can also change the default deploy interface used.
    #IRONIC_DEFAULT_DEPLOY_INTERFACE=direct

    # The parameters below represent the minimum possible values to create
    # functional nodes.
    IRONIC_VM_SPECS_RAM=2048
    IRONIC_VM_SPECS_DISK=10

    # Size of the ephemeral partition in GB. Use 0 for no ephemeral partition.
    IRONIC_VM_EPHEMERAL_DISK=0

    # To build your own IPA ramdisk from source, set this to True
    IRONIC_BUILD_DEPLOY_RAMDISK=False

    VIRT_DRIVER=ironic

    # By default, DevStack creates a 10.0.0.0/24 network for instances.
    # If this overlaps with the hosts network, you may adjust with the
    # following.
    # NETWORK_GATEWAY=10.1.0.1
    # FIXED_RANGE=10.1.0.0/24
    # FIXED_NETWORK_SIZE=256

    # Log all output to files
    LOGFILE=$HOME/devstack.log
    LOGDIR=$HOME/logs
    IRONIC_VM_LOG_DIR=$HOME/ironic-bm-logs

    END
